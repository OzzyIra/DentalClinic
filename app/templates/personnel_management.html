{% extends 'base.html' %}
{% load clinic_tags %}

{% block title %}Персонал — {{ clinic.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2>Управление персоналом</h2>

    <!-- Врачи -->
    <div class="card mb-3 doctors-table">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Врачи</h5>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-doctor-modal">Добавить врача</button>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ФИО</th>
                        <th>Специальность</th>
                        <th>Кабинет</th>
                        <th>Активен</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="doctors-list">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Медсёстры -->
    <div class="card mb-3 nurses-table">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Медсёстры</h5>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-nurse-modal">Добавить медсестру</button>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ФИО</th>
                        <th>Отделение</th>
                        <th>Кабинет</th>
                        <th>Активна</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="nurses-list">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Регистраторы -->
    <div class="card mb-3 receptionists-table">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Регистраторы</h5>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-receptionist-modal">Добавить регистратора</button>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ФИО</th>
                        <th>Офис</th>
                        <th>Активен</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="receptionists-list">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Модальное окно для врача -->
<div class="modal fade" id="add-doctor-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить/Изменить врача</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="doctor-form">
                    <input type="hidden" name="id" id="doctor-id">
                    <div class="mb-3">
                        <label>Фамилия</label>
                        <input type="text" class="form-control" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label>Имя</label>
                        <input type="text" class="form-control" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label>Отчество (необязательно)</label>
                        <input type="text" class="form-control" name="middle_name">
                    </div>
                    <div class="mb-3">
                        <label>Логин</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label>Пароль</label>
                        <input type="password" class="form-control" name="password">
                    </div>
                    <div class="mb-3">
                        <label>Специальность</label>
                        <input type="text" class="form-control" name="specialty" required>
                    </div>
                    <div class="mb-3">
                        <label>Кабинет</label>
                        <input type="text" class="form-control" name="room">
                    </div>
                    <div class="mb-3">
                        <label>Активен</label>
                        <input type="checkbox" name="is_active" checked>
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для медсестры -->
<div class="modal fade" id="add-nurse-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить/Изменить медсестру</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="nurse-form">
                    <input type="hidden" name="id" id="nurse-id">
                    <div class="mb-3">
                        <label>Фамилия</label>
                        <input type="text" class="form-control" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label>Имя</label>
                        <input type="text" class="form-control" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label>Отчество (необязательно)</label>
                        <input type="text" class="form-control" name="middle_name">
                    </div>
                    <div class="mb-3">
                        <label>Логин</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label>Пароль</label>
                        <input type="password" class="form-control" name="password">
                    </div>
                    <div class="mb-3">
                        <label>Отделение</label>
                        <input type="text" class="form-control" name="department">
                    </div>
                    <div class="mb-3">
                        <label>Кабинет</label>
                        <input type="text" class="form-control" name="room">
                    </div>
                    <div class="mb-3">
                        <label>Активна</label>
                        <input type="checkbox" name="is_active" checked>
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для регистратора -->
<div class="modal fade" id="add-receptionist-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить/Изменить регистратора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="receptionist-form">
                    <input type="hidden" name="id" id="receptionist-id">
                    <div class="mb-3">
                        <label>Фамилия</label>
                        <input type="text" class="form-control" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label>Имя</label>
                        <input type="text" class="form-control" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label>Отчество (необязательно)</label>
                        <input type="text" class="form-control" name="middle_name">
                    </div>
                    <div class="mb-3">
                        <label>Логин</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label>Пароль</label>
                        <input type="password" class="form-control" name="password">
                    </div>
                    <div class="mb-3">
                        <label>Офис</label>
                        <input type="text" class="form-control" name="office">
                    </div>
                    <div class="mb-3">
                        <label>Активен</label>
                        <input type="checkbox" name="is_active" checked>
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Загрузка врачей
    async function loadDoctors() {
        const res = await fetch('/api/personnel/doctors/');
        if (!res.ok) return;
        const doctors = await res.json();
        const tbody = document.getElementById('doctors-list');
        tbody.innerHTML = '';
        doctors.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.id}</td>
                <td>${d.full_name}</td>
                <td>${d.specialty}</td>
                <td>${d.room}</td>
                <td>${d.is_active ? 'Да' : 'Нет'}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-doctor" data-id="${d.id}">Изменить</button>
                    <button class="btn btn-sm btn-danger delete-doctor" data-id="${d.id}">Удалить</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Загрузка медсёстёр
    async function loadNurses() {
        const res = await fetch('/api/personnel/nurses/');
        if (!res.ok) return;
        const nurses = await res.json();
        const tbody = document.getElementById('nurses-list');
        tbody.innerHTML = '';
        nurses.forEach(n => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${n.id}</td>
                <td>${n.full_name}</td>
                <td>${n.department}</td>
                <td>${n.room}</td>
                <td>${n.is_active ? 'Да' : 'Нет'}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-nurse" data-id="${n.id}">Изменить</button>
                    <button class="btn btn-sm btn-danger delete-nurse" data-id="${n.id}">Удалить</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Загрузка регистраторов
    async function loadReceptionists() {
        const res = await fetch('/api/personnel/receptionists/');
        if (!res.ok) return;
        const receptionists = await res.json();
        const tbody = document.getElementById('receptionists-list');
        tbody.innerHTML = '';
        receptionists.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.id}</td>
                <td>${r.full_name}</td>
                <td>${r.office}</td>
                <td>${r.is_active ? 'Да' : 'Нет'}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-receptionist" data-id="${r.id}">Изменить</button>
                    <button class="btn btn-sm btn-danger delete-receptionist" data-id="${r.id}">Удалить</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Обработчик формы врача
    document.getElementById('doctor-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const id = formData.get('id');
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/personnel/doctors/${id}/update/` : '/api/personnel/doctors/create/';

        const data = {
            last_name: formData.get('last_name'),
            first_name: formData.get('first_name'),
            middle_name: formData.get('middle_name') || '',
            username: formData.get('username'),
            specialty: formData.get('specialty'),
            room: formData.get('room') || '',
            is_active: formData.get('is_active') ? true : false
        };
        if (formData.get('password')) data.password = formData.get('password');

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                document.getElementById('add-doctor-modal').querySelector('.btn-close').click();
                loadDoctors();
            } else {
                const err = await res.json();
                alert('Ошибка: ' + err.error);
            }
        } catch (err) {
            alert('Ошибка сети');
        }
    });

    // Обработчик формы медсестры
    document.getElementById('nurse-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const id = formData.get('id');
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/personnel/nurses/${id}/update/` : '/api/personnel/nurses/create/';

        const data = {
            last_name: formData.get('last_name'),
            first_name: formData.get('first_name'),
            middle_name: formData.get('middle_name') || '',
            username: formData.get('username'),
            department: formData.get('department') || '',
            room: formData.get('room') || '',
            is_active: formData.get('is_active') ? true : false
        };
        if (formData.get('password')) data.password = formData.get('password');

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                document.getElementById('add-nurse-modal').querySelector('.btn-close').click();
                loadNurses();
            } else {
                const err = await res.json();
                alert('Ошибка: ' + err.error);
            }
        } catch (err) {
            alert('Ошибка сети');
        }
    });

    // Обработчик формы регистратора
    document.getElementById('receptionist-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const id = formData.get('id');
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/personnel/receptionists/${id}/update/` : '/api/personnel/receptionists/create/';

        const data = {
            last_name: formData.get('last_name'),
            first_name: formData.get('first_name'),
            middle_name: formData.get('middle_name') || '',
            username: formData.get('username'),
            office: formData.get('office') || '',
            is_active: formData.get('is_active') ? true : false
        };
        if (formData.get('password')) data.password = formData.get('password');

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                document.getElementById('add-receptionist-modal').querySelector('.btn-close').click();
                loadReceptionists();
            } else {
                const err = await res.json();
                alert('Ошибка: ' + err.error);
            }
        } catch (err) {
            alert('Ошибка сети');
        }
    });

    // Редактирование врача
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-doctor')) {
            const id = e.target.dataset.id;
            fetch(`/api/personnel/doctors/${id}/`)
                .then(r => r.json())
                .then(data => {
                    const fullNameParts = data.full_name.split(' ');
                    document.getElementById('doctor-id').value = data.id;
                    document.querySelector('#doctor-form input[name="last_name"]').value = fullNameParts[0] || '';
                    document.querySelector('#doctor-form input[name="first_name"]').value = fullNameParts[1] || '';
                    document.querySelector('#doctor-form input[name="middle_name"]').value = fullNameParts[2] || '';
                    document.querySelector('#doctor-form input[name="username"]').value = data.user_username;
                    document.querySelector('#doctor-form input[name="specialty"]').value = data.specialty;
                    document.querySelector('#doctor-form input[name="room"]').value = data.room;
                    document.querySelector('#doctor-form input[name="is_active"]').checked = data.is_active;
                    new bootstrap.Modal(document.getElementById('add-doctor-modal')).show();
                });
        }
    });

    // Редактирование медсестры
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-nurse')) {
            const id = e.target.dataset.id;
            fetch(`/api/personnel/nurses/${id}/`)
                .then(r => r.json())
                .then(data => {
                    const fullNameParts = data.full_name.split(' ');
                    document.getElementById('nurse-id').value = data.id;
                    document.querySelector('#nurse-form input[name="last_name"]').value = fullNameParts[0] || '';
                    document.querySelector('#nurse-form input[name="first_name"]').value = fullNameParts[1] || '';
                    document.querySelector('#nurse-form input[name="middle_name"]').value = fullNameParts[2] || '';
                    document.querySelector('#nurse-form input[name="username"]').value = data.user_username;
                    document.querySelector('#nurse-form input[name="department"]').value = data.department;
                    document.querySelector('#nurse-form input[name="room"]').value = data.room;
                    document.querySelector('#nurse-form input[name="is_active"]').checked = data.is_active;
                    new bootstrap.Modal(document.getElementById('add-nurse-modal')).show();
                });
        }
    });

    // Редактирование регистратора
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-receptionist')) {
            const id = e.target.dataset.id;
            fetch(`/api/personnel/receptionists/${id}/`)
                .then(r => r.json())
                .then(data => {
                    const fullNameParts = data.full_name.split(' ');
                    document.getElementById('receptionist-id').value = data.id;
                    document.querySelector('#receptionist-form input[name="last_name"]').value = fullNameParts[0] || '';
                    document.querySelector('#receptionist-form input[name="first_name"]').value = fullNameParts[1] || '';
                    document.querySelector('#receptionist-form input[name="middle_name"]').value = fullNameParts[2] || '';
                    document.querySelector('#receptionist-form input[name="username"]').value = data.user_username;
                    document.querySelector('#receptionist-form input[name="office"]').value = data.office;
                    document.querySelector('#receptionist-form input[name="is_active"]').checked = data.is_active;
                    new bootstrap.Modal(document.getElementById('add-receptionist-modal')).show();
                });
        }
    });

    // Удаление врача
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-doctor')) {
            const id = e.target.dataset.id;
            if (confirm('Удалить врача?')) {
                fetch(`/api/personnel/doctors/${id}/delete/`, { method: 'DELETE' })
                    .then(() => loadDoctors());
            }
        }
    });

    // Удаление медсестры
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-nurse')) {
            const id = e.target.dataset.id;
            if (confirm('Удалить медсестру?')) {
                fetch(`/api/personnel/nurses/${id}/delete/`, { method: 'DELETE' })
                    .then(() => loadNurses());
            }
        }
    });

    // Удаление регистратора
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-receptionist')) {
            const id = e.target.dataset.id;
            if (confirm('Удалить регистратора?')) {
                fetch(`/api/personnel/receptionists/${id}/delete/`, { method: 'DELETE' })
                    .then(() => loadReceptionists());
            }
        }
    });

    // Загрузка при открытии страницы
    window.onload = function() {
        loadDoctors();
        loadNurses();
        loadReceptionists();
    };
</script>
{% endblock %}