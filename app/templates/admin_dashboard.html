{% extends 'base.html' %}
{% load clinic_tags %}

{% block title %}{{ clinic.name }} ‚Äî –ì–ª–∞–≤–≤—Ä–∞—á{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <!-- –ó–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
        <div class="col-md-3 col-section">
            <div class="section-title" id="section-title">
                –ó–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                <button id="add-btn" class="btn btn-sm btn-success ms-2">+</button>
                <button id="calendar-trigger" class="btn btn-sm btn-outline-secondary ms-1">üìÖ</button>
            </div>
            <small>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="scheduled-count">0</span></small>
            <div id="scheduled-list"></div>
        </div>

        <!-- –û–∂–∏–¥–∞—é—Ç –ø—Ä–∏–µ–º–∞ -->
        <div class="col-md-3 col-section">
            <div class="section-title">–û–∂–∏–¥–∞—é—Ç –ø—Ä–∏–µ–º–∞</div>
            <div id="waiting-list"></div>
        </div>

        <!-- –ù–∞ –ø—Ä–∏–µ–º–µ -->
        <div class="col-md-3 col-section">
            <div class="section-title">–ù–∞ –ø—Ä–∏–µ–º–µ</div>
            <div id="active-list"></div>
        </div>

        <!-- –ü—Ä–∏–µ–º –∑–∞–≤–µ—Ä—à–∏–ª–∏ -->
        <div class="col-md-3 col-section">
            <div class="section-title">–ü—Ä–∏–µ–º –∑–∞–≤–µ—Ä—à–∏–ª–∏</div>
            <div id="completed-list"></div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
<div class="modal fade" id="calendarModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-1 small text-muted">
                    <span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span>
                    <span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span>
                </div>
                <div id="cal-days" class="d-flex flex-wrap gap-1"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary btn-sm" id="apply-calendar">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const currentYear = {{ current_year }};
        const currentMonth = {{ current_month }};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        const triggerBtn = document.getElementById('calendar-trigger');
        const modalEl = document.getElementById('calendarModal');
        const modal = new bootstrap.Modal(modalEl);

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function generateCalendar(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            const container = document.getElementById('cal-days');
            container.innerHTML = '';

            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
            for (let i = 0; i < startDayOfWeek; i++) {
                const div = document.createElement('div');
                div.style.width = '28px';
                div.style.height = '28px';
                div.style.border = '1px solid #eee';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.fontSize = '0.8rem';
                div.style.cursor = 'default';
                container.appendChild(div);
            }

            // –î–Ω–∏ –º–µ—Å—è—Ü–∞
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.textContent = day;
                div.style.width = '28px';
                div.style.height = '28px';
                div.style.border = '1px solid #eee';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.style.fontSize = '0.8rem';
                div.style.cursor = 'pointer';
                div.classList.add('cal-day');
                div.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–µ–≥–æ–¥–Ω—è
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    div.style.backgroundColor = '#00C8B3';
                    div.style.color = 'white';
                    div.style.fontWeight = 'bold';
                }

                div.addEventListener('click', () => {
                    document.querySelectorAll('#cal-days .cal-day').forEach(d => d.style.backgroundColor = '');
                    div.style.backgroundColor = '#e0f7fa';
                    document.getElementById('selected-date').value = div.dataset.date;
                });

                container.appendChild(div);
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        triggerBtn.addEventListener('click', function() {
            generateCalendar(currentYear, currentMonth);
            modal.show();
        });

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É
        document.getElementById('apply-calendar').addEventListener('click', function() {
            const date = document.getElementById('selected-date').value;
            if (!date) return;
            loadSchedule(date, '');
            modal.hide();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        async function loadSchedule(date, doctorId) {
            try {
                const res = await fetch(`/api/schedule/?date=${date}${doctorId ? '&doctor_id=' + doctorId : ''}`);
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

                const data = await res.json();

                const [y, m, d] = date.split('-');
                const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω',
                                '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
                const newTitle = `–ó–∞–ø–∏—Å–∏ –Ω–∞ ${d}.${months[parseInt(m)-1]}.${y}`;
                const sectionTitle = document.getElementById('section-title');
                sectionTitle.innerHTML = newTitle;
                sectionTitle.innerHTML += `
                    <button id="add-btn" class="btn btn-sm btn-success ms-2">+</button>
                    <button id="calendar-trigger" class="btn btn-sm btn-outline-secondary ms-1">üìÖ</button>
                `;
                setupEventListeners();

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏
                updateSection('scheduled', data.scheduled || []);
                updateSection('waiting', data.waiting || []);
                updateSection('active', data.active || []);
                updateSection('completed', data.completed || []);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        function updateSection(section, items) {
            const container = document.getElementById(`${section}-list`);
            const countEl = document.getElementById(`${section}-count`);

            if (!container) return;

            container.innerHTML = items.length > 0
                ? items.map(i => `<div class="patient-card">${i.patient_name} ${i.time || ''} –≤—Ä ${i.doctor_name}</div>`).join('')
                : '<p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';

            if (countEl) countEl.textContent = items.length;
        }

        function setupEventListeners() {
            const addBtn = document.getElementById('add-btn');
            const calTrigger = document.getElementById('calendar-trigger');

            if (addBtn) {
                addBtn.removeEventListener('click', addBtn.handler);
                addBtn.handler = () => alert('–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å (–∑–∞–≥–ª—É—à–∫–∞)');
                addBtn.addEventListener('click', addBtn.handler);
            }

            if (calTrigger) {
                calTrigger.removeEventListener('click', calTrigger.handler);
                calTrigger.handler = () => {
                    generateCalendar(currentYear, currentMonth);
                    modal.show();
                };
                calTrigger.addEventListener('click', calTrigger.handler);
            }
        }

        // —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
        if (!document.getElementById('selected-date')) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.id = 'selected-date';
            document.body.appendChild(input);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
        setupEventListeners();
    });
</script>
{% endblock %}