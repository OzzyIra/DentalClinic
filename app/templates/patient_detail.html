{% extends 'base.html' %}
{% load clinic_tags %}

{% block title %}Карточка пациента — {{ patient.get_full_name }}{% endblock %}

{% block content %}
<div class="container mt-3">
    <h2>Карточка пациента: {{ patient.get_full_name }}</h2>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Основная информация</h5>
            <p><strong>ФИО:</strong> <span id="full-name">{{ patient.get_full_name }}</span></p>
            <p><strong>Дата рождения:</strong> <span id="birth-date">{{ patient.birth_date|date:"d.m.Y" }}</span></p>
            <p><strong>Телефон:</strong> <span id="phone">{{ patient.phone }}</span></p>
            <p><strong>Email:</strong> <span id="email">{{ patient.email|default:"—" }}</span></p>
            <p><strong>Скидка:</strong> <span id="discount">{{ patient.discount }}%</span></p>
            <p><strong>Заметки:</strong> <span id="notes">{{ patient.notes|default:"—" }}</span></p>
        </div>
    </div>

    <button id="edit-btn" class="btn btn-warning mt-3">Редактировать</button>
    <button id="save-btn" class="btn btn-success mt-3" style="display: none;">Сохранить</button>
    <a href="/patients-search/" class="btn btn-secondary mt-3">Назад к списку</a>

    <div id="edit-form" style="display: none;" class="mt-3">
        <h5>Редактировать данные</h5>
        <div class="mb-3">
            <label>Фамилия</label>
            <input type="text" class="form-control" id="edit-last-name" value="{{ patient.last_name }}">
        </div>
        <div class="mb-3">
            <label>Имя</label>
            <input type="text" class="form-control" id="edit-first-name" value="{{ patient.first_name }}">
        </div>
        <div class="mb-3">
            <label>Отчество</label>
            <input type="text" class="form-control" id="edit-middle-name" value="{{ patient.middle_name|default:'' }}">
        </div>
        <div class="mb-3">
            <label>Телефон</label>
            <input type="text" class="form-control" id="edit-phone" value="{{ patient.phone }}">
        </div>
        <div class="mb-3">
            <label>Дата рождения</label>
            <input type="date" class="form-control" id="edit-birth-date" value="{{ patient.birth_date|date:'Y-m-d' }}">
        </div>
        <div class="mb-3">
            <label>Email</label>
            <input type="email" class="form-control" id="edit-email" value="{{ patient.email|default:'' }}">
        </div>
        <div class="mb-3">
            <label>Скидка (%)</label>
            <input type="number" class="form-control" id="edit-discount" value="{{ patient.discount }}">
        </div>
        <div class="mb-3">
            <label>Заметки</label>
            <textarea class="form-control" id="edit-notes">{{ patient.notes|default:'' }}</textarea>
        </div>
    </div>
</div>

<script>
    const editBtn = document.getElementById('edit-btn');
    const saveBtn = document.getElementById('save-btn');
    const editForm = document.getElementById('edit-form');

    editBtn.addEventListener('click', () => {
        editForm.style.display = 'block';
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
    });

    saveBtn.addEventListener('click', async () => {
        const data = {
            last_name: document.getElementById('edit-last-name').value,
            first_name: document.getElementById('edit-first-name').value,
            middle_name: document.getElementById('edit-middle-name').value,
            phone: document.getElementById('edit-phone').value,
            birth_date: document.getElementById('edit-birth-date').value,
            email: document.getElementById('edit-email').value,
            discount: parseInt(document.getElementById('edit-discount').value),
            notes: document.getElementById('edit-notes').value
        };

        const res = await fetch(`/api/patients/{{ patient.pk }}/update/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            location.reload();  // Обновить страницу
        } else {
            const err = await res.json();
            alert('Ошибка: ' + err.error);
        }
    });
</script>
{% endblock %}